<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Text Annotation Viz Test</title>

    <link rel="stylesheet" type="text/css" href="./brat_client/style-vis.css"/>
    <link rel="stylesheet" type="text/css" href="./main.css"/>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" />

    <script type="text/javascript" src="./brat_client/client/lib/head.load.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>

    <script type="text/javascript">
        var bratLocation = './brat_client';

        head.js(
            // External libraries
            bratLocation + '/client/lib/jquery.min.js',
            bratLocation + '/client/lib/jquery.svg.min.js',
            bratLocation + '/client/lib/jquery.svgdom.min.js',

            // brat helper modules
            bratLocation + '/client/src/configuration.js',
            bratLocation + '/client/src/util.js',
            bratLocation + '/client/src/annotation_log.js',
            bratLocation + '/client/lib/webfont.js',

            // brat modules
            bratLocation + '/client/src/dispatcher.js',
            bratLocation + '/client/src/url_monitor.js',
            bratLocation + '/client/src/visualizer.js'
        );

        var webFontURLs = [
            // bratLocation + '/static/fonts/Astloch-Bold.ttf',
            bratLocation + '/static/fonts/PT_Sans-Caption-Web-Regular.ttf',
            bratLocation + '/static/fonts/Liberation_Sans-Regular.ttf'
        ];
    </script>
    <script src="/text-viz.js" type="text/javascript"></script>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.min.js"></script>
<div class="container">
    <div class="jumbotron">
        <h1>Cogcomp Pipeline Demo</h1>
        <p>
            The Illinois NLP Pipeline provides a suite of state-of-the-art Natural Language Processing tools
            that allows you to run various NLP tools to annotate plain text input.
        </p>
        <button type="button" onclick="location.href='https://github.com/CogComp/cogcomp-nlp/tree/master/pipeline';" class="btn btn-danger btn-xs">Read More</button>
    </div>

    <div id="main-content">
        <div>Enter text to annotate below:</div>
        <div id="input-area" style="width: 100%" >
            <textarea rows="3" cols="80" style="width: 100%" id="viz-text">Mary has a little lamb.</textarea>
            <input type="submit" class="btn btn-default" id="viz-submit">
            <select id="example-getting-started" multiple="multiple">
                <option value="ner">NER</option>
                <option value="pos">POS</option>
                <option value="dep">Dependency</option>
                <option value="srl">SRL</option>
            </select>
        </div>
        <div id="render-area"></div>
    </div>

</div>

<script>

    const sampleData = textViz.sampleData;

    head.ready(function () {
        console.log('Loading and rendering');

        const _ = textViz.lodash;
        const pipelineViews = [ "POS", "NER_CONLL", "NER_ONTONOTES" ];

        // Util.profileEnable();

        var createViewArea = function (renderDivId, viewName, viewType) {
            var outerDiv = $("<div>").attr("class", "view-area");
            outerDiv.append($("<div class='alert alert-success visualization-block' role='alert'>").text(viewName + " // " + viewType).attr("id", renderDivId));
            return outerDiv;
        };

        $("#viz-submit").click(function (eventData) {
            var text = $("#viz-text").val();
            console.log(text);
            console.log($("#viz-text"));

            var p = text ? Promise.resolve(text) : Promise.reject("Invalid Text");
            p.then(function (text) {
                $("#render-area").empty();

                return textViz.pipelineClient.annotateText({}, text, pipelineViews).then(function (jsonData) {
                    return jsonData;
                }, function (err) {
                    // Return Sample Data in case of network error.
                    return sampleData;
                });
            }).then(function (jsonData) {
                var availableViews = textViz.getAvailableViews(jsonData);

                var viewInfos = _.filter(availableViews, function (viewInfo) {
                    return $.inArray(viewInfo.type, textViz.supportedTypes) !== -1 && viewInfo.name !== "TOKENS";
                });

                _.forEach(viewInfos, function (viewInfo) {
                    if(viewInfo.name == "DEPENDENCY_HEADFINDER:PARSE_STANFORD") return;

                    console.log("Rendering");
                    var divId = viewInfo.name;
                    var newDiv = createViewArea(divId, viewInfo.name, viewInfo.type);
                    $("#render-area").append(newDiv);
                    var bratData = textViz.render(jsonData, viewInfo, {});
                    Util.embed(divId, bratData.collectionData, bratData.documentData, webFontURLs);
                });
            }, function (err) {
                console.log(err);

                var bratData = textViz.render(sampleData,
                    {
                        name: "SHALLOW_PARSE",
                        type: "edu.illinois.cs.cogcomp.core.datastructures.textannotation.SpanLabelView"
                    });
                Util.embed('render-area', bratData.collectionData, bratData.documentData, webFontURLs);
            });
        });


        $('#example-getting-started').multiselect({
            includeSelectAllOption: true
        });
    });
</script>
</body>
</html>